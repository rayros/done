"use strict";!function(){window.todoDatabase={version:3,name:"todo",polyfill:function(e,t){return this.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB||window.shimIndexedDB,this.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange||window.shimIndexedDB.modules.IDBKeyRange,this.isIOS8()&&(this.indexedDB=window.shimIndexedDB,this.IDBKeyRange=window.shimIndexedDB.modules.IDBKeyRange),this.indexedDB?e.call(this):t.call(this)},init:function(e){this.polyfill(function(){this.open(e)},function(){console.log("DB: Your browser doesn't support a stable version of IndexedDB.\n Such and such feature will not be available.")})},Version:function(e){return{check:function(t){return e.oldVersion<t&&e.newVersion>=t?!0:!1}}},isIOS8:function(){var e=navigator.userAgent.toLowerCase();return/(iphone|ipod|ipad).* os 8_/.test(e)},open:function(e){var t=this,n=t.indexedDB.open(this.name,this.version);n.onsuccess=function(t){return e&&e(t),t.target.result.close(),!1},n.onupgradeneeded=function(e){var n,o=e.target.result,r=e.target.transaction,s=t.Version(e);s.check(2)&&(n=o.createObjectStore("tasks",{keyPath:"id",autoIncrement:!0}),n.createIndex("category, checked",["category","checked"],{unique:!1}),o.createObjectStore("categories",{keyPath:"id",autoIncrement:!0}),o.createObjectStore("current",{keyPath:"key"}),t.addCategory("events"),t.setCurrent("category",{id:1,name:"events"})),s.check(3)&&(n=r.objectStore("tasks"),n.createIndex("category",["category"],{unique:!1}))},n.onerror=function(e){console.log("DB: error - "+e.target.error.message)}},transaction:function(e,t){this.open(function(n){var o=n.target.result,r=o.transaction(e,"readwrite");r.onerror=function(e){console.log("DB: Transaction not opened due to error."),console.log(e.target.error.message)},t(r)})},setCurrent:function(e,t,n){this.transaction("current",function(o){var r=o.objectStore("current"),s=r.put({key:e,value:t});s.onsuccess=function(){n&&n()}})},current:function(e,t){var n=this;n.transaction("current",function(n){var o=n.objectStore("current").get(e);o.onsuccess=function(e){return t(e.target.result.value),!1}})},addTask:function(e,t){this.transaction("tasks",function(n){var o=n.objectStore("tasks"),r=o.add({name:e,category:t.id,checked:0});r.onsuccess=function(){}})},updateTask:function(e,t){var n=this;this.transaction("tasks",function(o){var r=o.objectStore("tasks"),s=r.get(e);s.onsuccess=function(e){var o=n.merge(e.target.result,t);r.put(o)}})},getTask:function(e,t){var n=this;n.transaction("tasks",function(n){var o=n.objectStore("tasks").get(e);o.onsuccess=function(e){t(e.target.result)}})},deleteTask:function(e,t){this.transaction(["tasks"],function(n){var o=n.objectStore("tasks"),r=o.delete(e);r.onsuccess=function(e){t&&t(e)}})},tasks:function(e,t,n){var o=this,r=[];o.transaction("tasks",function(s){var a=s.objectStore("tasks").index("category, checked"),i=a.openCursor(o.IDBKeyRange.only([e.id,t]),"prev");i.onsuccess=function(e){var t=e.target.result;return t?(r.push(t.value),t.continue(),void 0):n(r)}})},addCategory:function(e,t){this.transaction("categories",function(n){var o=n.objectStore("categories"),r=o.add({name:e.toLowerCase()});r.onsuccess=function(n){t&&t({id:n.target.result,name:e})}})},updateCategory:function(e,t,n){var o=this;this.transaction("categories",function(r){var s=r.objectStore("categories"),a=s.get(e);a.onsuccess=function(e){var r=o.merge(e.target.result,t);s.put(r),n&&n(r)}})},deleteCategory:function(e,t,n){return 1===e?(n&&n(),void 0):(this.transaction(["categories","tasks"],function(n){var o=n.objectStore("categories"),r=n.objectStore("tasks"),s=r.index("category"),a=s.openCursor(IDBKeyRange.only([e]));a.onsuccess=function(n){var s=n.target.result;if(s)r.delete(s.value.id),s.continue();else{var a=o.delete(e);a.onsuccess=function(){t&&t(n)}}}}),void 0)},categories:function(e){var t=this,n=[];t.transaction("categories",function(t){var o=t.objectStore("categories");o.openCursor().onsuccess=function(t){var o=t.target.result;return o?(n.push(o.value),o.continue(),void 0):e(n)}})},deleteDB:function(e){var t=this.indexedDB.deleteDatabase(this.name);t.onsuccess=function(){e&&e()},t.onerror=function(){console.log("Couldn't delete database")},t.onblocked=function(){console.log("Couldn't delete database due to the operation being blocked")}},merge:function(e,t){var n={};for(var o in e)n[o]=e[o];for(var r in t)n[r]=t[r];return n}}}(),function(){todoDatabase.init()}();